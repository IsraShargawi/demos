<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Form</title>
    <!-- SurveyJS Form Library -->
    <link href="https://unpkg.com/survey-core/survey-core.min.css" type="text/css" rel="stylesheet">
    <script src="https://unpkg.com/survey-core/survey.core.min.js"></script>
    <script src="https://unpkg.com/survey-js-ui/survey-js-ui.min.js"></script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #3c7042;
            --secondary-color: #4361ee;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
            --info-color: #7209b7;
            --light-bg: #f8f9fa;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
            --sidebar-width: 240px;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #eaf5ee 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            display: flex;
        }
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(135deg, #3c7042 0%, #4361ee 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 32px 0 0 0;
            box-shadow: 2px 0 12px rgba(60,112,66,0.07);
            position: fixed;
            left: 0;
            top: 0;
            z-index: 100;
        }
        .sidebar .logo {
            font-size: 2rem;
            font-weight: 900;
            letter-spacing: 2px;
            color: #fff;
            margin-left: 32px;
            margin-bottom: 32px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sidebar .nav {
            width: 100%;
            flex: 1;
        }
        .sidebar .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 32px;
            color: #fff;
            text-decoration: none;
            font-weight: 500;
            font-size: 1.08rem;
            border-left: 4px solid transparent;
            transition: background 0.2s, border-color 0.2s;
        }
        .sidebar .nav-link.active,
        .sidebar .nav-link:hover {
            background: rgba(255,255,255,0.08);
            border-left: 4px solid #fff;
            color: #fff;
        }
        .sidebar .logout-btn {
            margin: 32px 0 0 32px;
            background: #fff;
            color: var(--primary-color);
            border: none;
            border-radius: 8px;
            padding: 10px 24px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .sidebar .logout-btn:hover {
            background: #eaf5ee;
            color: #2e5c35;
        }
        .main-content {
            margin-left: var(--sidebar-width);
            width: calc(100vw - var(--sidebar-width));
            min-height: 100vh;
            background: transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        .survey-container {
            background: white;
            border-radius: 18px;
            box-shadow: 0 8px 32px rgba(60,112,66,0.10);
            overflow: hidden;
            width: 100%;
            max-width: 900px;
            margin: 40px 0 20px 0;
        }
        .survey-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 36px 32px 24px 32px;
            text-align: left;
            border-radius: 18px 18px 0 0;
            border-bottom: 1px solid #eaf5ee;
        }
        .survey-header h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: 1px;
        }
        .survey-header .description {
            margin-top: 10px;
            opacity: 0.95;
            font-size: 1.1rem;
        }
        .survey-content {
            padding: 40px 40px 20px 40px;
            min-height: 400px;
        }
        .progress-container {
            margin-bottom: 30px;
        }
        .progress {
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar {
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }
        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            color: #666;
            font-size: 14px;
        }
        .survey-footer {
            padding: 20px 40px;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .btn-custom {
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .btn-primary-custom {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary-custom:hover {
            background-color: #2e5c35;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(60,112,66,0.13);
        }
        .btn-secondary-custom {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary-custom:hover {
            background-color: #545b62;
        }
        .completion-screen {
            text-align: center;
            padding: 60px 40px;
        }
        .completion-icon {
            font-size: 80px;
            color: var(--primary-color);
            margin-bottom: 30px;
        }
        .completion-screen h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        .completion-screen p {
            color: #666;
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        .survey-info {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid var(--primary-color);
        }
        .survey-info p {
            margin: 5px 0;
            color: #666;
        }
        .survey-info strong {
            color: #333;
        }
        .time-indicator {
            background-color: #e8f5e9;
            color: #2e7d32;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .required-star {
            color: var(--warning-color);
            margin-left: 2px;
        }
        .error-panel {
            background-color: #ffebee;
            color: var(--warning-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--warning-color);
            display: none;
        }
        .error-panel.show {
            display: block;
        }
        .error-panel ul {
            margin: 10px 0 0 0;
            padding-left: 20px;
        }
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
        .thank-you-message {
            background-color: #e8f5e9;
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
            text-align: center;
        }
        .survey-expired {
            padding: 60px 40px;
            text-align: center;
        }
        .survey-expired .icon {
            font-size: 80px;
            color: var(--warning-color);
            margin-bottom: 30px;
        }
        .privacy-notice {
            font-size: 12px;
            color: #888;
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .question-counter {
            background-color: var(--primary-color);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
            display: inline-block;
        }
        #surveyHostContainer {
            min-height: 300px;
        }
        .empty-survey-message {
            text-align: center;
            padding: 60px 40px;
            color: #666;
        }
        .empty-survey-message .icon {
            font-size: 80px;
            color: #ccc;
            margin-bottom: 20px;
        }
        @media (max-width: 900px) {
            .main-content { margin-left: 0; width: 100vw;}
            .sidebar { display: none;}
            .survey-container { margin: 20px 0;}
        }
        @media (max-width: 768px) {
            .survey-container { border-radius: 10px; box-shadow: none;}
            .survey-content { padding: 20px;}
            .survey-header { padding: 20px;}
            .survey-footer { padding: 15px 20px; flex-direction: column; gap: 15px;}
            .survey-footer button { width: 100%;}
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">
            <i class="fas fa-leaf"></i> Sadeed
        </div>
        <nav class="nav flex-column w-100">
            <a class="nav-link active" href="/demo2/survey-runner"><i class="fas fa-clipboard-list"></i> Take Survey</a>
            <a class="nav-link" href="/demo2/main"><i class="fas fa-pen-nib"></i> Survey Builder</a>
        </nav>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
    <div class="main-content" style="margin-left:var(--sidebar-width); width:calc(100vw - var(--sidebar-width));">
        <!-- Loading Screen -->
        <div class="loading-screen" id="loadingScreen">
            <div class="spinner"></div>
            <h3>Loading Survey</h3>
            <p>Please wait while we prepare your survey...</p>
        </div>

        <!-- Main Survey Container -->
        <div class="survey-container" id="surveyContainer" style="display: none;">
            <!-- Survey Header -->
            <div class="survey-header">
                <h1 id="surveyTitle">Survey</h1>
                <div class="description" id="surveyDescription"></div>
            </div>

            <!-- Survey Info Panel -->
            <div class="survey-info" id="surveyInfo" style="display: none;">
                <p><strong>Survey ID:</strong> <span id="surveyIdDisplay"></span></p>
                <p><strong>Estimated time:</strong> <span id="estimatedTime">5-10 minutes</span></p>
                <p><strong>Your progress will be automatically saved</strong></p>
            </div>

            <!-- Error Panel -->
            <div class="error-panel" id="errorPanel">
                <strong><i class="fas fa-exclamation-circle"></i> Please fix the following errors:</strong>
                <ul id="errorList"></ul>
            </div>

            <!-- Time Indicator -->
            <div class="time-indicator" id="timeIndicator" style="display: none;">
                <i class="fas fa-clock"></i>
                <span>Time spent: <span id="timeSpent">0:00</span></span>
            </div>

            <!-- Progress Bar -->
            <div class="progress-container">
                <div class="progress">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
                <div class="progress-text">
                    <span>Progress</span>
                    <span id="progressText">0%</span>
                </div>
            </div>

            <!-- Question Counter -->
            <div class="question-counter" id="questionCounter" style="display: none;">
                Page <span id="currentQuestion">1</span> of <span id="totalQuestions">0</span>
            </div>

            <!-- Survey Content -->
            <div class="survey-content">
                <!-- Empty Survey Message -->
                <div class="empty-survey-message" id="emptySurveyMessage" style="display: none;">
                    <div class="icon">
                        <i class="fas fa-clipboard-question"></i>
                    </div>
                    <h3>No Questions Found</h3>
                    <p id="emptyMessage">This survey doesn't have any questions yet.</p>
                    <p>Please contact the survey administrator.</p>
                </div>
                
                <!-- Survey Host Container -->
                <div id="surveyHostContainer">
                    <!-- Survey will be rendered here -->
                </div>
                
                <!-- Completion Screen (Initially hidden) -->
                <div class="completion-screen" id="completionScreen" style="display: none;">
                    <div class="completion-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h2>Thank You!</h2>
                    <p id="completionMessage">Your responses have been submitted successfully. We appreciate your time and feedback.</p>
                    
                    <div class="thank-you-message" id="thankYouMessage" style="display: none;">
                        <h4><i class="fas fa-gift"></i> Special Thanks!</h4>
                        <p id="customThankYou">Your feedback is invaluable to us. We'll use it to improve our services.</p>
                    </div>
                    
                    <button class="btn-custom btn-primary-custom" onclick="window.location.href = '/'">
                        <i class="fas fa-home"></i> Return to Home
                    </button>
                    
                    <div class="privacy-notice">
                        <i class="fas fa-shield-alt"></i> Your responses are confidential and will be used for research purposes only.
                    </div>
                </div>

                <!-- Expired Survey Screen -->
                <div class="survey-expired" id="expiredScreen" style="display: none;">
                    <div class="icon">
                        <i class="fas fa-calendar-times"></i>
                    </div>
                    <h2 id="expiredTitle">Survey Expired</h2>
                    <p id="expiredMessage">This survey is no longer accepting responses.</p>
                    <p>Please contact the survey administrator if you believe this is an error.</p>
                    <button class="btn-custom btn-secondary-custom" onclick="window.location.href = '/'">
                        <i class="fas fa-arrow-left"></i> Go Back
                    </button>
                </div>
            </div>

            <!-- Survey Footer -->
            <div class="survey-footer" id="surveyFooter" style="display: none;">
                <button class="btn-custom btn-secondary-custom" id="prevBtn">
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                
                <div class="d-flex gap-2">
                    <button class="btn-custom btn-secondary-custom" id="saveBtn">
                        <i class="fas fa-save"></i> Save Progress
                    </button>
                    <button class="btn-custom btn-primary-custom" id="nextBtn">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                    <button class="btn-custom btn-primary-custom" id="completeBtn" style="display: none;">
                        <i class="fas fa-paper-plane"></i> Submit Survey
                    </button>
                </div>
            </div>
        </div>

        <script>
            // Global variables
            let surveyModel;
            let startTime;
            let timeInterval;
            let linkCode;
            let surveyData;
            let sessionId;
            let responseId;

            // Initialize when page loads
            document.addEventListener('DOMContentLoaded', function() {
                // Get link code from URL
                const pathParts = window.location.pathname.split('/');
                linkCode = pathParts[pathParts.length - 1];
                
                if (!linkCode || linkCode === 'survey') {
                    showSurveyExpired('Invalid survey link');
                    return;
                }
                
                console.log('Loading survey with code:', linkCode);
                
                // Generate session ID
                sessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                // Setup event listeners first
                setupEventListeners();
                
                // Load the survey
                loadSurvey();
                
                // Start timer
                startTime = Date.now();
                updateTimer();
                timeInterval = setInterval(updateTimer, 1000);
            });

            function setupEventListeners() {
                // Navigation buttons
                document.getElementById('prevBtn').addEventListener('click', () => {
                    if (surveyModel && surveyModel.currentPageNo > 0) {
                        surveyModel.prevPage();
                    }
                });
                
                document.getElementById('nextBtn').addEventListener('click', () => {
                    if (!surveyModel) return;
                    
                    // Validate current page before proceeding
                    if (!surveyModel.validateCurrentPage(true)) {
                        return;
                    }
                    
                    if (surveyModel.isLastPage) {
                        showCompletionConfirmation();
                    } else {
                        surveyModel.nextPage();
                    }
                });
                
                document.getElementById('completeBtn').addEventListener('click', () => {
                    showCompletionConfirmation();
                });
                
                document.getElementById('saveBtn').addEventListener('click', saveProgress);
            }

            async function loadSurvey() {
                try {
                    showLoading(true);
                    
                    // Fetch survey data using the link code
                    const response = await fetch(`/demo2/api/survey-by-link/${linkCode}`);
                    
                    if (!response.ok) {
                        let errorMessage = 'Survey not found';
                        
                        if (response.status === 410) {
                            const data = await response.json();
                            errorMessage = data.error || 'Survey link has expired';
                        } else if (response.status === 404) {
                            errorMessage = 'Survey not found';
                        }
                        
                        showSurveyExpired(errorMessage);
                        return;
                    }
                    
                    const result = await response.json();
                    console.log('API Response received:', result);
                    
                    if (result.success) {
                        surveyData = result.survey;
                        console.log('Survey data loaded successfully');
                        console.log('Survey has', surveyData.pages_count, 'pages and', surveyData.questions_count, 'questions');
                        
                        // Delay initialization slightly to ensure DOM is ready
                        setTimeout(() => {
                            initializeSurvey(surveyData);
                        }, 100);
                    } else {
                        throw new Error(result.error || 'Failed to load survey');
                    }
                } catch (error) {
                    console.error('Error loading survey:', error);
                    showSurveyExpired('Failed to load survey: ' + error.message);
                }
            }

            function initializeSurvey(surveyJson) {
                try {
                    console.log('Initializing survey with data:', surveyJson);
                    
                    // Validate survey JSON
                    if (!surveyJson || !surveyJson.json) {
                        console.error('No survey JSON found');
                        showEmptySurvey('No survey data found');
                        return;
                    }
                    
                    // Check if survey has pages and questions
                    const hasQuestions = surveyJson.json.pages && 
                                       surveyJson.json.pages.length > 0 &&
                                       surveyJson.json.pages.some(page => page.elements && page.elements.length > 0);
                    
                    if (!hasQuestions) {
                        console.warn('Survey has no questions');
                        showEmptySurvey('This survey has no questions');
                        return;
                    }
                    
                    // Create a clean container for the survey
                    const surveyHostContainer = document.getElementById('surveyHostContainer');
                    surveyHostContainer.innerHTML = '';
                    
                    // Create a new div for the survey
                    const surveyDiv = document.createElement('div');
                    surveyDiv.id = 'surveyElement';
                    surveyHostContainer.appendChild(surveyDiv);
                    
                    // Create survey model
                    console.log('Creating survey model with JSON...');
                    surveyModel = new Survey.Model(surveyJson.json);
                    console.log('Survey model created successfully');
                    
                    // Set survey title and description
                    document.getElementById('surveyTitle').textContent = surveyJson.title || 'Survey';
                    if (surveyJson.description) {
                        document.getElementById('surveyDescription').textContent = surveyJson.description;
                    }
                    
                    // Show survey info
                    document.getElementById('surveyInfo').style.display = 'block';
                    document.getElementById('surveyIdDisplay').textContent = surveyJson.id || linkCode;
                    
                    // Configure survey options
                    surveyModel.showProgressBar = "none";
                    surveyModel.showQuestionNumbers = "on";
                    surveyModel.requiredText = "*";
                    surveyModel.showCompletedPage = false;
                    surveyModel.focusFirstQuestionAutomatic = true;
                    
                    // Render the survey using the DOM element, not a string
                    surveyModel.render(surveyDiv);
                    console.log('Survey rendered successfully');
                    
                    // Update UI elements
                    updateProgress();
                    updateQuestionCounter();
                    updateNavigationButtons();
                    
                    // Show survey container and footer
                    document.getElementById('surveyContainer').style.display = 'block';
                    document.getElementById('surveyFooter').style.display = 'flex';
                    showLoading(false);
                    
                    // Show time indicator if enabled
                    if (surveyJson.settings?.showTimer) {
                        document.getElementById('timeIndicator').style.display = 'flex';
                    }
                    
                    // Set up survey event handlers
                    surveyModel.onCurrentPageChanged.add(function() {
                        console.log('Page changed to:', surveyModel.currentPageNo);
                        updateProgress();
                        updateQuestionCounter();
                        updateNavigationButtons();
                        hideErrors();
                    });
                    
                    surveyModel.onValueChanged.add(function(sender, options) {
                        console.log('Value changed:', options.question?.name, '=', options.value);
                        debouncedAutoSave();
                    });
                    
                    surveyModel.onComplete.add(handleSurveyComplete);
                    
                    surveyModel.onValidatedErrorsOnCurrentPage.add(function(sender, options) {
                        console.log('Validation errors:', options.errors);
                        showValidationErrors(options.errors);
                    });
                    
                    // Check for saved progress
                    setTimeout(() => checkSavedProgress(), 500);
                    
                } catch (error) {
                    console.error('Error initializing survey:', error);
                    showEmptySurvey('Failed to load survey questions: ' + error.message);
                    showLoading(false);
                }
            }

            function updateProgress() {
                if (!surveyModel) return;
                
                const progress = surveyModel.getProgress();
                const progressPercent = Math.round(progress * 100);
                
                document.getElementById('progressBar').style.width = `${progressPercent}%`;
                document.getElementById('progressText').textContent = `${progressPercent}%`;
            }

            function updateQuestionCounter() {
                if (!surveyModel) return;
                
                const currentPageIndex = surveyModel.currentPageNo + 1;
                const totalPages = surveyModel.visiblePages.length;
                
                document.getElementById('questionCounter').style.display = 'block';
                document.getElementById('currentQuestion').textContent = currentPageIndex;
                document.getElementById('totalQuestions').textContent = totalPages;
            }

            function updateNavigationButtons() {
                if (!surveyModel) return;
                
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                const completeBtn = document.getElementById('completeBtn');
                
                // Previous button
                prevBtn.disabled = surveyModel.currentPageNo === 0;
                prevBtn.style.opacity = prevBtn.disabled ? '0.5' : '1';
                prevBtn.style.cursor = prevBtn.disabled ? 'not-allowed' : 'pointer';
                
                // Next/Complete buttons
                if (surveyModel.isLastPage) {
                    nextBtn.style.display = 'none';
                    completeBtn.style.display = 'block';
                } else {
                    nextBtn.style.display = 'block';
                    completeBtn.style.display = 'none';
                }
            }

            function updateTimer() {
                if (!startTime) return;
                
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                
                document.getElementById('timeSpent').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }

            function showValidationErrors(errors) {
                const errorPanel = document.getElementById('errorPanel');
                const errorList = document.getElementById('errorList');
                
                if (errors && errors.length > 0) {
                    errorList.innerHTML = '';
                    errors.forEach(error => {
                        const li = document.createElement('li');
                        li.textContent = error.getText();
                        errorList.appendChild(li);
                    });
                    errorPanel.classList.add('show');
                    
                    // Scroll to error panel
                    errorPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            function hideErrors() {
                document.getElementById('errorPanel').classList.remove('show');
            }

            async function saveProgress() {
                try {
                    if (!surveyModel || surveyModel.state === 'completed') return;
                    
                    const saveData = {
                        response_data: surveyModel.data,
                        session_id: sessionId,
                        completion_percentage: Math.round(surveyModel.getProgress() * 100),
                        time_spent_seconds: Math.floor((Date.now() - startTime) / 1000),
                        is_complete: false
                    };
                    
                    console.log('Saving progress:', saveData);
                    
                    // Store in localStorage
                    localStorage.setItem(`survey_progress_${linkCode}`, JSON.stringify({
                        data: saveData,
                        timestamp: Date.now()
                    }));
                    
                    // Save to server
                    if (surveyData && surveyData.id) {
                        await fetch(`/demo2/api/surveys/${surveyData.id}/responses`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(saveData)
                        });
                    }
                    
                    showNotification('Progress saved successfully!', 'success');
                } catch (error) {
                    console.error('Error saving progress:', error);
                    showNotification('Progress saved locally', 'info');
                }
            }

            async function checkSavedProgress() {
                const savedData = localStorage.getItem(`survey_progress_${linkCode}`);
                
                if (savedData && surveyModel) {
                    try {
                        const { data, timestamp } = JSON.parse(savedData);
                        
                        // Check if data is recent (less than 7 days old)
                        const isRecent = Date.now() - timestamp < 7 * 24 * 60 * 60 * 1000;
                        
                        if (isRecent && confirm('We found a saved progress from your last session. Would you like to resume?')) {
                            // Restore data
                            if (data.response_data) {
                                Object.keys(data.response_data).forEach(key => {
                                    surveyModel.setValue(key, data.response_data[key]);
                                });
                            }
                            
                            // Update UI
                            updateProgress();
                            updateQuestionCounter();
                            
                            showNotification('Progress restored successfully!', 'success');
                        }
                    } catch (error) {
                        console.error('Error restoring progress:', error);
                    }
                }
            }

            async function handleSurveyComplete(sender) {
                try {
                    showLoading(true);
                    
                    const timeSpent = Math.floor((Date.now() - startTime) / 1000);
                    
                    const responseData = {
                        survey_id: surveyData.id,
                        response_data: sender.data,
                        session_id: sessionId,
                        completion_percentage: 100,
                        time_spent_seconds: timeSpent,
                        is_complete: true
                    };
                    
                    console.log('Submitting survey response:', responseData);
                    
                    // Submit response
                    const response = await fetch(`/demo2/api/surveys/${surveyData.id}/responses`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(responseData)
                    });
                    
                    const result = await response.json();
                    console.log('Submission response:', result);
                    
                    if (result.success) {
                        responseId = result.response_id;
                        
                        // Clear saved progress
                        localStorage.removeItem(`survey_progress_${linkCode}`);
                        
                        // Stop timer
                        clearInterval(timeInterval);
                        
                        // Show completion screen
                        showCompletionScreen();
                        
                    } else {
                        throw new Error(result.error || 'Failed to submit survey');
                    }
                } catch (error) {
                    console.error('Error submitting survey:', error);
                    showNotification('Failed to submit survey. Please try again.', 'error');
                    document.getElementById('completeBtn').disabled = false;
                    document.getElementById('completeBtn').innerHTML = '<i class="fas fa-paper-plane"></i> Submit Survey';
                } finally {
                    showLoading(false);
                }
            }

            function showCompletionScreen() {
                // Hide survey elements
                document.getElementById('surveyHostContainer').style.display = 'none';
                document.getElementById('surveyFooter').style.display = 'none';
                // Fix: Hide all elements with class 'progress-container'
                document.querySelectorAll('.progress-container').forEach(el => el.style.display = 'none');
                document.getElementById('questionCounter').style.display = 'none';
                document.getElementById('timeIndicator').style.display = 'none';
                document.getElementById('surveyInfo').style.display = 'none';
                document.getElementById('errorPanel').style.display = 'none';
                
                // Show completion screen
                document.getElementById('completionScreen').style.display = 'block';
                
                // Add response ID
                if (responseId) {
                    const message = document.getElementById('completionMessage');
                    message.innerHTML += `<br><small>Response ID: ${responseId}</small>`;
                }
            }

            function showCompletionConfirmation() {
                if (!surveyModel) return;
                
                if (!surveyModel.validateCurrentPage(true)) {
                    return;
                }
                
                if (confirm('Are you sure you want to submit your survey? You will not be able to make changes after submission.')) {
                    document.getElementById('completeBtn').disabled = true;
                    document.getElementById('completeBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
                    surveyModel.doComplete();
                }
            }

            function showEmptySurvey(message) {
                showLoading(false);
                document.getElementById('surveyContainer').style.display = 'block';
                document.getElementById('emptySurveyMessage').style.display = 'block';
                document.getElementById('surveyFooter').style.display = 'none';
                document.getElementById('surveyHostContainer').style.display = 'none';
                
                if (message) {
                    document.getElementById('emptyMessage').textContent = message;
                }
            }

            function showSurveyExpired(message) {
                showLoading(false);
                document.getElementById('surveyContainer').style.display = 'block';
                document.getElementById('expiredScreen').style.display = 'block';
                document.getElementById('surveyHostContainer').style.display = 'none';
                
                if (message) {
                    document.getElementById('expiredMessage').textContent = message;
                }
            }

            function showLoading(show) {
                document.getElementById('loadingScreen').style.display = show ? 'flex' : 'none';
            }

            function showNotification(message, type) {
                // Create notification
                const notification = document.createElement('div');
                notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show`;
                notification.style.position = 'fixed';
                notification.style.top = '20px';
                notification.style.right = '20px';
                notification.style.zIndex = '9999';
                notification.style.minWidth = '300px';
                notification.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 5000);
            }

            // Debounced auto-save
            let autoSaveTimeout;
            function debouncedAutoSave() {
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(() => {
                    if (surveyModel && surveyModel.state !== 'completed') {
                        saveProgress();
                    }
                }, 30000);
            }

            // Handle page unload
            window.addEventListener('beforeunload', function(e) {
                if (surveyModel && surveyModel.state !== 'completed') {
                    saveProgress().catch(() => {});
                }
            });

            // Add logout logic
            function logout() {
                localStorage.removeItem('userLoggedIn');
                localStorage.removeItem('survey_user_email');
                localStorage.removeItem('survey_user_name');
                window.location.href = '/login';
            }
        </script>
    </div>
</body>
</html>